name: Build NHL JSON

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *" # every 30 min

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps (none needed)
        run: python -V

      # Non-fatal network probes to both hosts
      - name: Network sanity check (both hosts)
        continue-on-error: true
        run: |
          set -euxo pipefail
          for host in statsapi.web.nhl.com api-web.nhle.com; do
            echo "Probing https://$host/ ..."
            (curl -fsS --max-time 10 "https://$host/" >/dev/null && echo "OK: $host") || echo "WARN: $host not reachable now"
          done

      - name: Build nhl.json for today (Toronto time)
        env:
          OUTFILE: nhl.json
          # To test a specific date, uncomment:
          # SCHEDULE_DATE: "2025-10-08"
        run: |
          python3 scripts/fetch_nhl.py

      - name: Commit & push nhl.json
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add nhl.json
          if git diff --cached --quiet; then
            echo "No changes."
          else
            git commit -m "Update nhl.json"
            git push
          fi
