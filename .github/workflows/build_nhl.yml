name: Build NHL JSON

on:
  workflow_dispatch:
  schedule:
    # GitHub cron is UTC.

    # Mon–Wed 7pm–1am ET = Tue–Thu 00:00–05:59 UTC (every 5 min)
    - cron: "*/5 0-5 * * 2-4"
    # Mon–Wed include 01:00 ET exactly = Tue–Thu 06:00 UTC
    - cron: "0 6 * * 2-4"

    # Thu–Sun 4pm–1am ET = Thu–Sun 21:00–23:59 UTC (every 5 min)
    - cron: "*/5 21-23 * * 4,5,6,0"

    # Thu–Sun 4pm–1am ET continues after midnight:
    # Fri–Mon 00:00–05:59 UTC (every 5 min)
    - cron: "*/5 0-5 * * 5,6,0,1"
    # Include 01:00 ET exactly = 06:00 UTC (Fri–Mon)
    - cron: "0 6 * * 5,6,0,1"

permissions:
  contents: write

concurrency:
  group: nhl-json
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps (none needed)
        run: python -V

      - name: Network sanity check (both hosts)
        continue-on-error: true
        run: |
          set -euxo pipefail
          for host in statsapi.web.nhl.com api-web.nhle.com; do
            echo "Probing https://$host/ ..."
            (curl -fsS --max-time 10 "https://$host/" >/dev/null && echo "OK: $host") || echo "WARN: $host not reachable now"
          done

      - name: Build nhl.json for today (Toronto time)
        env:
          OUTFILE: nhl.json
        run: |
          set -e
          python3 scripts/fetch_nhl.py
          test -s nhl.json
          mkdir -p newsriver
          cp nhl.json newsriver/nhl.json
          echo "Preview of nhl.json:"
          head -c 200 nhl.json || true
          echo
          echo "Preview of newsriver/nhl.json:"
          head -c 200 newsriver/nhl.json || true
          echo

      - name: Commit & push nhl.json (root + /newsriver) with rebase
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git fetch origin
          git checkout main
          git pull --rebase --autostash origin main

          git add nhl.json newsriver/nhl.json

          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git commit -m "Update nhl.json"
          for i in 1 2 3; do
            if git push origin main; then
              echo "Push succeeded."
              exit 0
            fi
            echo "Push failed. Attempt $i. Rebasing and retrying..."
            git fetch origin
            git pull --rebase --autostash origin main || true
            sleep 2
          done

          echo "Push failed after retries."
          exit 1
