name: Build NHL JSON

on:
  workflow_dispatch:
  schedule:
    # NOTE: GitHub Actions cron uses UTC, not Eastern.
    # Mon–Wed: run 7pm–1am ET  => 00:00–06:59 UTC (next day), every 5 min
    - cron: "*/5 0-6 * * 2-4"

    # Thu–Sun: run 4pm–1am ET => 21:00–23:59 UTC (same day), every 5 min
    - cron: "*/5 21-23 * * 4-0"

    # Thu–Sun: run 4pm–1am ET => 00:00–06:59 UTC (next day), every 5 min
    - cron: "*/5 0-6 * * 5-1"

permissions:
  contents: write

concurrency:
  group: nhl-json
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed for rebase

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps (none needed)
        run: python -V

      # Non-fatal network probes to both hosts
      - name: Network sanity check (both hosts)
        continue-on-error: true
        run: |
          set -euxo pipefail
          for host in statsapi.web.nhl.com api-web.nhle.com; do
            echo "Probing https://$host/ ..."
            (curl -fsS --max-time 10 "https://$host/" >/dev/null && echo "OK: $host") || echo "WARN: $host not reachable now"
          done

      - name: Build nhl.json for today (Toronto time)
        env:
          OUTFILE: nhl.json
          # To test a specific date, uncomment:
          # SCHEDULE_DATE: "2025-10-08"
        run: |
          set -e
          python3 scripts/fetch_nhl.py
          test -s nhl.json
          mkdir -p newsriver
          cp nhl.json newsriver/nhl.json
          echo "Preview of nhl.json:"
          head -c 200 nhl.json || true
          echo
          echo "Preview of newsriver/nhl.json:"
          head -c 200 newsriver/nhl.json || true
          echo

      - name: Commit & push nhl.json (root + /newsriver) with rebase
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Rebase on latest main to avoid non-fast-forward
          git fetch origin
          git checkout main
          git pull --rebase --autostash origin main

          git add nhl.json newsriver/nhl.json

          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git commit -m "Update nhl.json"
          # Push with a simple retry to ride out brief races
          for i in 1 2 3; do
            if git push origin main; then
              echo "Push succeeded."
              exit 0
            fi
            echo "Push failed. Attempt $i. Rebasing and retrying..."
            git fetch origin
            git pull --rebase --autostash origin main || true
            sleep 2
          done

          echo "Push failed after retries."
          exit 1
