name: Build headlines.json (full nightly)

on:
  schedule:
    # Runs daily at 04:12 ET (08:12 UTC during Standard Time; adjust as needed)
    - cron: '12 8 * * *'
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: build-headlines-full
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 12
    env:
      PYTHONUNBUFFERED: "1"
      # Server-side knobs for the fetcher (safe defaults)
      MPB_MAX_PER_FEED: "14"
      MPB_MAX_TOTAL: "320"
      MPB_HTTP_TIMEOUT: "12"
      MPB_SLOW_FEED_WARN: "3.5"
      MPB_GLOBAL_BUDGET: "210"
      MPB_UA: "NewsRiverBot/1.3 (+https://mypybite.github.io/newsriver/)"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install feedparser requests json5

      - name: Build headlines.json (FULL)
        run: |
          test -f feeds.txt || { echo "feeds.txt missing" >&2; exit 1; }
          # Hard wall clock; donâ€™t fail the whole job if it hits the wall.
          timeout -k 10s 300s python scripts/fetch_headlines.py --feeds-file feeds.txt --out headlines.json || echo "::warning::full build hit timeout"

      - name: Show summary
        if: hashFiles('headlines.json') != ''
        run: |
          python - <<'PY'
          import json
          with open('headlines.json','r',encoding='utf-8') as f:
              d = json.load(f)
          dbg = d.get("_debug", {})
          print("generated_utc:", d.get("generated_utc"))
          print("items:", d.get("count"))
          print("weights_loaded:", dbg.get("weights_loaded"))
          print("weights_keys:", ", ".join(dbg.get("weights_keys", [])) or "(none)")
          for it in d.get("items",[])[:3]:
              print(" -", it.get("title","")[:140])
          PY

      - name: Commit headlines.json (if changed)
        if: hashFiles('headlines.json') != ''
        run: |
          if ! git diff --quiet -- headlines.json; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add headlines.json
            git commit -m "build(full): nightly refresh headlines.json"
            git push
          else
            echo "No changes to headlines.json."
          fi
