<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NewsRiver (TEST) — Latest Headlines</title>

  <!-- Styles -->
  <link rel="stylesheet" href="assets/styles.css" />

  <!-- Substack CTA styles (small, self-contained) -->
  <style>
    /* Header CTA chip */
    .cta-subscribe {
      margin-left: .75rem;
      text-decoration: none;
    }

    /* Prompt shell */
    #signupPrompt {
      position: fixed;
      inset: auto 16px 16px auto;
      max-width: 360px;
      z-index: 9999;
      display: none;             /* toggled by JS */
      opacity: 0;                /* for fade-in */
      transform: translateY(8px);/* for slide-in */
      transition: opacity .25s ease, transform .25s ease;
      border-radius: 14px;
      border: 1px solid rgba(120,130,140,.35);
      padding: 14px 14px 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.28);
      backdrop-filter: saturate(1.05) blur(2px);
    }
    #signupPrompt.show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    #signupPrompt .hdr {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin: 2px 0 6px;
      font-weight: 700;
      font-size: 0.98rem;
      letter-spacing: .02em;
    }
    #signupPrompt .sub {
      font-size: .88rem;
      line-height: 1.35;
      opacity: .9;
      margin-bottom: .6rem;
    }
    #signupPrompt .row {
      display: flex;
      gap: 10px;
      margin-top: .45rem;
    }
    #signupPrompt .btn {
      appearance: none;
      border-radius: 999px;
      padding: .55rem .9rem;
      font: 600 .9rem/1 system-ui,-apple-system,Segoe UI,Helvetica,Arial,sans-serif;
      cursor: pointer;
      border: 1px solid transparent;
    }
    #signupPrompt .btn.primary {
      background: #f1f5ff;
      color: #0f172a;
      border-color: rgba(30,60,90,.18);
    }
    #signupPrompt .btn.ghost {
      background: transparent;
      color: inherit;
      border-color: rgba(120,130,140,.35);
    }
    #signupPrompt .x {
      appearance: none;
      border: none;
      background: transparent;
      color: inherit;
      font: 600 1rem/1 system-ui,-apple-system,Segoe UI,Helvetica,Arial,sans-serif;
      cursor: pointer;
      opacity: .8;
    }
    #signupPrompt .x:focus { outline: 2px solid currentColor; outline-offset: 2px; }

    /* Light / dark */
    @media (prefers-color-scheme: dark) {
      #signupPrompt { background: rgba(20,26,34,.92); color: #e6edf7; }
    }
    @media (prefers-color-scheme: light) {
      #signupPrompt { background: rgba(246,249,255,.98); color: #0f172a; border-color: rgba(30,60,90,.18); }
    }

    /* Small screens: center at bottom */
    @media (max-width: 480px){
      #signupPrompt { inset: auto 12px 12px 12px; }
    }
  </style>

  <!-- Social/SEO (optional) -->
  <meta name="description" content="Curated, newest-first news river with lightweight scoring and filters." />
</head>
<body>
  <header class="header">
    <div style="display:flex;align-items:center;flex-wrap:wrap;gap:.4rem;">
      <h1 class="title">NewsRiver TEST</h1>
      <!-- Header Subscribe chip -->
      <a class="chip cta-subscribe" href="https://mypybite.substack.com/subscribe" target="_blank" rel="noopener" aria-label="Subscribe on Substack">
        Subscribe (FREE)
      </a>
    </div>
    <p class="subtitle">Newest-first headlines (auto-built from RSS)</p>
  </header>

  <!-- Toolbar: filters on the left, “Last updated” chip will be injected on the right -->
  <section class="toolbar" role="region" aria-label="Controls">
    <div class="filters" id="filters">
      <!-- Category filters -->
      <button class="chip chip-active" data-filter="all" aria-pressed="true">All</button>
      <button class="chip" data-filter="Sports">Sports</button>
      <button class="chip" data-filter="General">General</button>

      <!-- Region filters -->
      <span class="divider" aria-hidden="true"></span>
      <button class="chip" data-region="Canada">Canada</button>
      <button class="chip" data-region="US">US</button>
      <button class="chip" data-region="World">World</button>
    </div>

    <!-- JS will append: <div id="last-updated" class="chip">Last updated: …</div> -->
  </section>

  <!-- Results -->
  <main id="grid" class="grid" aria-live="polite">
    <!-- Cards are injected here -->
  </main>

  <!-- Debug/links -->
  <footer class="footer">
    <a href="headlines.json" target="_blank" rel="noopener">View raw headlines.json</a>
    <span class="dot">•</span>
    <a href="https://github.com/MyPyBiTE/newsriver" target="_blank" rel="noopener">GitHub</a>
  </footer>

  <!-- Substack signup prompt (dismissible) -->
  <div id="signupPrompt" role="dialog" aria-modal="false" aria-labelledby="signupTitle">
    <div class="hdr">
      <div id="signupTitle">Get our best headlines by email</div>
      <button class="x" type="button" aria-label="Close" id="signupClose">×</button>
    </div>
    <div class="sub">By Subscribing you gain insight into totally free trade secrets and technicals. As well as constructive diatribes. Take the 7 seconds to provide your email and over time you will have helped grow the kind of community that will not shill you.</div>
    <div class="row">
      <a id="signupGo" class="btn primary" href="https://mypybite.substack.com/subscribe" target="_blank" rel="noopener">Subscribe</a>
      <button id="signupDismiss" class="btn ghost" type="button">No thanks</button>
    </div>
  </div>

  <noscript>
    <p style="padding:1rem;max-width:800px;margin:1rem auto;background:#222;border-radius:12px;">
      JavaScript is required to load headlines. You can still view
      <a href="headlines.json">headlines.json</a>.
    </p>
  </noscript>

  <!-- Optional: point to your live JSON hosted on GitHub Pages -->
  <script>
    // If you serve index.html from somewhere else, keep this so the app reads the JSON from GitHub Pages.
    // You can remove or change this if your headlines.json is local.
    window.NEWSRIVER_JSON_URL = window.NEWSRIVER_JSON_URL || "https://mypybite.github.io/newsriver/headlines.json";
  </script>

  <!-- Data loader (fetch, strong de-dupe, per-source cap, stable order, filters, last-updated, auto-refresh) -->
  <script>
  (function(){
    "use strict";

    // ---------- DOM refs ----------
    const GRID = document.getElementById('grid');
    const FILTERS = document.getElementById('filters');
    const TOOLBAR = document.querySelector('.toolbar');

    // Create & insert the "Last updated" chip on the right
    const lastChip = document.createElement('div');
    lastChip.id = 'last-updated';
    lastChip.className = 'chip';
    lastChip.setAttribute('aria-live', 'polite');
    lastChip.textContent = 'Last updated: …';
    TOOLBAR.appendChild(lastChip);

    // Active filters (single category; single region)
    let activeCategory = 'all';
    let activeRegion = null;

    // ---------- Config ----------
    const JSON_URL = (window.NEWSRIVER_JSON_URL || 'headlines.json');
    const REFRESH_MS = 5 * 60 * 1000; // 5 minutes
    let lastStamp = null; // remember last generated_utc

    // Per-source caps (default = 1 per source)
    const CAP_PER_SOURCE_DEFAULT = 1;
    const CAP_OVERRIDES = {
      // Example bumps (edit as you like):
      "cbc.ca": 2,
      "globalnews.ca": 2,
      "reuters.com": 2,
      "financialpost.com": 2
    };

    // Sports sites that may allow +1 cap in the evening window
    const SPORTS_SITES = new Set([
      "mlb.com",
      "espn.com",
      "sportsnet.ca",
      "tsn.ca",
      "theathletic.com",
      "cbssports.com",
      "bleacherreport.com",
      "sports.yahoo.com"
    ]);

    // ---------- Utilities ----------
    const TZ = 'America/Toronto';
    const QS = new URLSearchParams(location.search);

    // Dev/testing flags:
    //   ?debug=boosts  -> show badges with minutes + reasons
    //   ?noboost=1     -> disable boosts (recency only)
    //   ?hr=17         -> simulate 17:00 (5pm) ET daypart
    //   ?snark=1       -> apply display-only XRP/Ripple renames
    const DEBUG_BOOSTS = QS.get('debug') === 'boosts';
    const NO_BOOSTS = QS.has('noboost');
    const HR_OVERRIDE = (()=>{
      const v = QS.get('hr');
      if (v == null) return null;
      const n = Number(v);
      return Number.isFinite(n) && n >= 0 && n <= 23 ? n : null;
    })();
    const SNARKY_RENAMES = QS.has('snark');

    // (debug) lightweight CSS for badges, injected only when needed
    if (DEBUG_BOOSTS) {
      const style = document.createElement('style');
      style.textContent = `
        .boost-badge{
          display:inline-flex; align-items:center; gap:.35rem;
          margin-top:.4rem; padding:.25rem .5rem; border-radius:999px;
          font-size:.72rem; line-height:1; white-space:nowrap;
          border:1px solid rgba(120,130,140,.45);
          color:#cfe7ff; background:rgba(25,35,45,.55); backdrop-filter:saturate(1.1) blur(2px);
        }
        .boost-badge .mins{opacity:.9;font-weight:600}
        .boost-badge .reasons{opacity:.85}
        @media (prefers-color-scheme: light){
          .boost-badge{ color:#16324f; background:rgba(220,235,255,.7); border-color:rgba(30,60,90,.2); }
        }
      `;
      document.head.appendChild(style);
    }

    const isValidDate = (v) => !!v && !Number.isNaN(Date.parse(v));
    const fmtET = (iso) => {
      try {
        const d = new Date(iso);
        return new Intl.DateTimeFormat('en-CA', {
          year:'numeric', month:'short', day:'2-digit',
          hour:'2-digit', minute:'2-digit', hour12:false,
          timeZone: TZ
        }).format(d) + ' ET';
      } catch { return iso; }
    };
    const clearGrid = () => { GRID.innerHTML = ''; };

    function hourInTZ(){
      if (HR_OVERRIDE != null) return HR_OVERRIDE;
      const p = new Intl.DateTimeFormat('en-CA',{ timeZone: TZ, hour: '2-digit', hour12: false })
        .formatToParts(new Date());
      const hh = Number(p.find(x=>x.type==='hour').value);
      return Number.isFinite(hh) ? hh : new Date().getHours();
    }

    // ---------- URL & source helpers ----------
    function hostOf(url) {
      try {
        const u = new URL(url, location.href);
        return (u.hostname || "").replace(/^www\./i,"").toLowerCase();
      } catch { return ""; }
    }
    function sourceKey(it) {
      // Prefer domain; fall back to source label lowercased
      return hostOf(it?.canonical_url || it?.url || "") || String(it?.source||"").toLowerCase();
    }

    // ---------- De-dupe helpers ----------
    function normalizeTitle(t) {
      return (t || "")
        .replace(/\s+[-–—]\s+[^|]+$/u, "")       // drop trailing " - Source"
        .toLowerCase()
        .replace(/[\u2010-\u2015]/g, "-")        // unify dashes
        .replace(/[^\p{L}\p{N}]+/gu, " ")        // remove punctuation
        .trim()
        .replace(/\s+/g, " ");
    }
    // Strong key: fuzzy title signature + domain (so “same headline” from same site collapses)
    function dedupeKey(it) {
      const t = normalizeTitle(it?.title || "");
      const h = hostOf(it?.canonical_url || it?.url || "");
      return `k:${t}|${h}`;
    }
    function isAggregator(it) {
      const src = `${it?.source || ""} ${it?.url || ""}`.toLowerCase();
      return /news\.google|google news|yahoo\.com\/news|apple\.news|flipboard|feedproxy/.test(src);
    }
    // Keep only the newest item per key; if tie, prefer non-aggregator.
    function dedupeItems(items) {
      const byKey = new Map();
      for (const it of items) {
        const key = dedupeKey(it);
        const prev = byKey.get(key);
        if (!prev) {
          byKey.set(key, it);
          continue;
        }
        const tNew = Date.parse(it.published_utc || it.published || 0) || 0;
               const tOld = Date.parse(prev.published_utc || prev.published || 0) || 0;

        if (tNew > tOld) {
          byKey.set(key, it);
        } else if (tNew === tOld) {
          if (isAggregator(prev) && !isAggregator(it)) byKey.set(key, it);
        }
      }
      return Array.from(byKey.values());
    }

    // ---------- Stable, monotonic “first seen” sequence ----------
    const SEQ_STORAGE_KEY = "nr_seq_v1";
    function loadSeqState() {
      try {
        const raw = localStorage.getItem(SEQ_STORAGE_KEY);
        if (!raw) return { counter: 0, map: {} };
        const parsed = JSON.parse(raw);
        return {
          counter: Number(parsed?.counter || 0),
          map: parsed?.map && typeof parsed.map === "object" ? parsed.map : {}
        };
      } catch { return { counter: 0, map: {} }; }
    }
    function saveSeqState(state) {
      try { localStorage.setItem(SEQ_STORAGE_KEY, JSON.stringify(state)); } catch {}
    }
    function getItemId(it) { return dedupeKey(it); }
    function assignStableSeq(items) {
      const state = loadSeqState();
      let touched = false;
      for (const it of items) {
        const id = getItemId(it);
        if (state.map[id] == null) {
          state.counter += 1;
          state.map[id] = state.counter;
          touched = true;
        }
        it.__seq = state.map[id];
      }
      if (touched) saveSeqState(state);
      return items;
    }

    // ---------- Per-source cap (variety guard) ----------
    function capForDomain(domain, hour){
      let limit = CAP_OVERRIDES[domain] ?? CAP_PER_SOURCE_DEFAULT;
      const evening = hour >= 15 && hour <= 23;
      if (evening && SPORTS_SITES.has(domain)) {
        // allow one extra slot for key sports outlets in the evening
        limit = Math.max(limit, 2);
      }
      return limit;
    }

    function applySourceCap(sortedItems, hour) {
      const counts = Object.create(null);
      const out = [];
      for (const it of sortedItems) {
        const key = sourceKey(it);
        const limit = capForDomain(key, hour);
        const n = counts[key] || 0;
        if (n < limit) {
          out.push(it);
          counts[key] = n + 1;
        }
      }
      return out;
    }

    // ---------- Display-only title transforms (optional) ----------
    function transformTitleForDisplay(t){
      if (!SNARKY_RENAMES) return t || '';
      return String(t || '')
        .replace(/\bXRP\b/gi, 'Shitcoin')
        .replace(/\bRipple\b/gi, 'Maker of shitcoins');
    }

    // ---------- Render ----------
    function makeCard(item){
      const card = document.createElement('article');
      card.className = 'card';
      card.dataset.category = item.category || '';
      card.dataset.region = item.region || '';

      const link = document.createElement('a');
      link.className = 'card-link';
      link.href = item.url;
      link.target = '_blank';
      link.rel = 'noopener';
      link.setAttribute('aria-label', item.title || 'Open headline');

      const h2 = document.createElement('h2');
      h2.className = 'headline';
      h2.textContent = transformTitleForDisplay(item.title || '(untitled)');

      link.appendChild(h2);

      const meta = document.createElement('div');
      meta.className = 'meta';

      const src = document.createElement('span');
      src.className = 'source';
      src.textContent = item.source || '';

      const cat = document.createElement('span');
      cat.className = 'tag';
      cat.textContent = item.category || '';

      const reg = document.createElement('span');
      reg.className = 'tag';
      reg.textContent = item.region || '';

      meta.appendChild(src);
      if (item.category){ meta.appendChild(document.createTextNode(' \u2022 ')); meta.appendChild(cat); }
      if (item.region){ meta.appendChild(document.createTextNode(' \u2022 ')); meta.appendChild(reg); }

      card.appendChild(link);
      card.appendChild(meta);

      // Debug: show boost reasons if enabled
      if (DEBUG_BOOSTS) {
        const dbg = document.createElement('div');
        dbg.className = 'boost-badge';
        const mins = Math.round((item.__boost_ms || 0) / 60000);
        const reasons = (item.__boost_reasons || []).join(', ') || 'no boosts';
        dbg.innerHTML = `<span class="mins">+${mins}m</span><span class="reasons">${reasons}</span>`;
        card.appendChild(dbg);
      }

      return card;
    }

    function render(items){
      clearGrid();
      if (!items || items.length === 0){
        const p = document.createElement('p');
        p.className = 'empty';
        p.textContent = 'No headlines match your filters.';
        GRID.appendChild(p);
        return;
      }
      const frag = document.createDocumentFragment();
      items.forEach(it => frag.appendChild(makeCard(it)));
      GRID.appendChild(frag);
    }

    function applyFilters(all){
      const filtered = all.filter(it =>
        (activeCategory === 'all' || (it.category || '') === activeCategory) &&
        (!activeRegion || (it.region || '') === activeRegion)
      );
      render(filtered);
    }

    function setLastUpdated(isoMaybe){
      if (isValidDate(isoMaybe)) {
        lastChip.textContent = 'Last updated: ' + fmtET(isoMaybe);
      } else {
        lastChip.textContent = 'Last updated: just now';
      }
    }

    // ---------- Thematic + daypart scoring (adds “time credit” in minutes) ----------
    // The “5% stronger” nudges are implemented as small additive time credits.

    const MINUTE = 60 * 1000;
    const BUMP_5  = 12 * MINUTE;           // ~5% nudge unit
    const BUMP_8  = 18 * MINUTE;           // slightly stronger
    const BUMP_10 = 24 * MINUTE;           // stronger
    const WAR_BUMP = 60 * MINUTE;          // high-priority war/security
    const TIER1_BUMP = 6 * MINUTE;         // mild nudge for tier-1 sources
    const FINALS_BUMP = 15 * MINUTE;       // end-of-game closure nudge
    const ATHLETE_BUMP = 12 * MINUTE;      // named athlete nudge
    const KIRK_EXTRA = 6 * MINUTE;         // Alejandro Kirk extra (on top of athlete)
    const BOOST_CAP = 3 * 60 * MINUTE;     // avoid bulldozing

    const RE_TIER1 = /\b(associated press|^ap$|reuters|bbc|bloomberg|financial times|wall street journal|washington post|the guardian|new york times|nyt)\b/i;

    // Business/markets (morning)
    const RE_CRYPTO = /\b(crypto|bitcoin|btc|ethereum|eth|halving|stablecoin|defi|satoshi)\b/i;
    const RE_MEME   = /\b(gamestop|gme|amc)\b/i;
    const RE_TECH   = /\b(nvda|nvidia|msft|microsoft|aapl|apple|amzn|amazon|googl?|google|alphabet|meta|facebook|tsla|tesla|ai|chip(?:s|makers)?|semiconductor)\b/i;

    // War/security (always-on) — must match a region + an event word
    const RE_WAR_EVENT  = /\b(war|attack|attacks|attacked|strike|air[-\s]?strike|missile|drone|invasion|mobilization|shell(?:ing)?|artillery|frontline|casualties?|dead|killed)\b/i;
    const RE_WAR_REGION = /\b(russia|ukraine|poland|serbia|croatia|bosnia|herzegovina|kosovo|montenegro|slovenia|macedonia|albania|hungary|slovakia|czech|austria|romania|bulgaria|balkan|central europe|canada|united states|u\.s\.|usa)\b/i;

    // Sports (afternoon/evening) — teams and athletes
    const RE_SPORTS_TEAMS = /\b(toronto (blue\s?jays|jays|maple\s?leafs|leafs|raptors|raps)|new york yankees|yankees|boston red sox|red sox|detroit tigers|los angeles dodgers|dodgers)\b/i;
    const RE_SPORTS_ABBR  = /\b(NYY|BOS|DET|LAD)\b/;
    const RE_SPORTS_ATHLETES = /\b(shohei ohtani|vladimir guerrero(?: jr\.?)?|george springer|bo bichette|max scherzer|alejandro kirk)\b/i;
    const RE_KIRK = /\balejandro kirk\b/i;
    // “Final”/closure words or scorelines like 3-1 / 10–2 / "final score"
    const RE_FINALS_CUE = /\b(final(?: score)?|wins?|defeats?|beats?|edges?|falls?|prevails?|clinches?|walk-?off)\b|(?:\b\d{1,2}\s?[–-]\s?\d{1,2}\b)/i;

    function computeBoost(it, hour){
      if (NO_BOOSTS) return { ms: 0, reasons: [] };

      const title = String(it?.title || '');
      const source = String(it?.source || '');
      let boost = 0;
      const reasons = [];

      // Always-on: war & security (region + event)
      if (RE_WAR_EVENT.test(title) && RE_WAR_REGION.test(title)) {
        boost += WAR_BUMP; reasons.push('war');
      }

      // Dayparts (Toronto time)
      // Morning 06:00–13:00 → business/markets
      if (hour >= 6 && hour < 13){
        if (RE_CRYPTO.test(title)) { boost += (BUMP_10 + BUMP_5); reasons.push('crypto'); }
        if (RE_MEME.test(title))   { boost += BUMP_8; reasons.push('meme'); }
        if (RE_TECH.test(title))   { boost += BUMP_5; reasons.push('tech'); }
      }

      // Afternoon/Evening 15:00–23:30 → sports dopamine
      if (hour >= 15 && hour <= 23){
        if (RE_SPORTS_TEAMS.test(title))     { boost += BUMP_8; reasons.push('team'); }
        if (RE_SPORTS_ABBR.test(title))      { boost += BUMP_5; reasons.push('abbr'); }
        if (RE_SPORTS_ATHLETES.test(title))  { boost += ATHLETE_BUMP; reasons.push('athlete'); }
        if (RE_KIRK.test(title))             { boost += KIRK_EXTRA; reasons.push('kirk+'); }
        if (RE_FINALS_CUE.test(title))       { boost += FINALS_BUMP; reasons.push('final'); }
      }

      // Mild tier-1 nudge
      if (RE_TIER1.test(source)) { boost += TIER1_BUMP; reasons.push('tier1'); }

      // Clamp
      if (boost > BOOST_CAP) boost = BOOST_CAP;

      return { ms: boost, reasons };
    }

    function scoringSort(items){
      const now = Date.now();
      const hr = hourInTZ();

      for (const it of items){
        const pubMs = Date.parse(it.published_utc || it.published || 0) || 0;
        const base = pubMs || (now - (it.__seq || 0)); // tiny fallback if no date
        const { ms: bonus, reasons } = computeBoost(it, hr);
        // expose for debug overlay
        it.__boost_ms = bonus;
        it.__boost_reasons = reasons;
        // __seq used as ultra-small stabilizer inside ties
        it.__score = base + bonus + ((it.__seq || 0) % 997); // tiny tie shaper
      }

      // Highest score first (recency + boosts)
      items.sort((a,b) => (b.__score||0) - (a.__score||0));
      return items;
    }

    // ---------- Normalize incoming data (de-dupe + seq + SCORE + per-source cap) ----------
    function normalizeData(data){
      if (!data || !Array.isArray(data.items)) return { items: [] };

      // A) strong de-dupe (title sig + domain; prefer originals over aggregators)
      let items = dedupeItems(data.items.slice());

      // B) stable first-seen id (for gentle tie shaping)
      assignStableSeq(items);

      // C) score by recency + daypart/topic boosts
      scoringSort(items);

      // D) cap per source to keep variety (default 1 unless overridden/relaxed by window)
      items = applySourceCap(items, hourInTZ());

      return { ...data, items };
    }

    // ---------- Fetch helpers ----------
    async function loadJson() {
      const url = `${JSON_URL}?t=${Date.now()}`; // cache-buster
      const resp = await fetch(url, { cache: 'no-store' });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return await resp.json();
    }

    async function bootstrap() {
      try {
        const data = await loadJson();
        const normalized = normalizeData(data);

        // Save for re-filtering via the toolbar
        window.__NR_ALL_ITEMS__ = normalized.items;

        // Set “Last updated” using generated_utc (preferred) or newest item time
        const lastIso = data.generated_utc && isValidDate(data.generated_utc)
          ? data.generated_utc
          : (normalized.items.find(it => isValidDate(it.published_utc))?.published_utc || null);

        setLastUpdated(lastIso);
        lastStamp = data.generated_utc || null;

        // Initial render
        applyFilters(normalized.items);
      } catch (err) {
        console.error('Headlines load failed:', err);
        setLastUpdated(null);
        clearGrid();
        const p = document.createElement('p');
        p.className = 'error';
        p.textContent = 'Could not load headlines. Try opening headlines.json directly or refresh.';
        GRID.appendChild(p);
      }
    }

    function autoRefresh() {
      setInterval(async () => {
        try {
          const data = await loadJson();
          if (!data) return;

          const stamp = data.generated_utc || null;
          if (stamp && stamp !== lastStamp) {
            const normalized = normalizeData(data);
            window.__NR_ALL_ITEMS__ = normalized.items;
            setLastUpdated(stamp);
            lastStamp = stamp;
            applyFilters(normalized.items);

            lastChip.classList.add('pulse');
            setTimeout(() => lastChip.classList.remove('pulse'), 900);
          }
        } catch (e) {
          console.warn('Auto-refresh failed:', e.message);
        }
      }, REFRESH_MS);
    }

    // ---------- Filter click handling (single-select per group) ----------
    FILTERS.addEventListener('click', (e) => {
      const btn = e.target.closest('button.chip');
      if (!btn) return;

      // Category group
      if (btn.hasAttribute('data-filter')){
        FILTERS.querySelectorAll('[data-filter]').forEach(b => {
          b.classList.remove('chip-active');
          b.setAttribute('aria-pressed', 'false');
        });
        btn.classList.add('chip-active');
        btn.setAttribute('aria-pressed', 'true');
        activeCategory = btn.getAttribute('data-filter') || 'all';
        applyFilters(window.__NR_ALL_ITEMS__ || []);
      }

      // Region group (toggle single-select)
      if (btn.hasAttribute('data-region')){
        const region = btn.getAttribute('data-region') || null;
        if (activeRegion === region){
          activeRegion = null;
          btn.classList.remove('chip-active');
          btn.setAttribute('aria-pressed', 'false');
        } else {
          FILTERS.querySelectorAll('[data-region]').forEach(b => {
            b.classList.remove('chip-active');
            b.setAttribute('aria-pressed', 'false');
          });
          activeRegion = region;
          btn.classList.add('chip-active');
          btn.setAttribute('aria-pressed', 'true');
        }
        applyFilters(window.__NR_ALL_ITEMS__ || []);
      }
    });

    // ---------- Go ----------
    bootstrap();
    autoRefresh();
  })();
  </script>

  <!-- Substack signup prompt logic (one-time, dismissible) -->
  <script>
    (function(){
      const el = document.getElementById('signupPrompt');
      const btnX = document.getElementById('signupClose');
      const btnNo = document.getElementById('signupDismiss');
      const linkYes = document.getElementById('signupGo');
      if (!el || !btnX || !btnNo || !linkYes) return;

      const STORAGE_KEY = 'mpb_substack_prompt';
      const NOCTA = new URLSearchParams(location.search).has('nocta'); // ?nocta=1 disables prompt (handy for screenshots)
      const now = Date.now();

      function getState(){
        try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch { return {}; }
      }
      function setState(obj){
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); } catch {}
      }
      function days(n){ return n*24*60*60*1000; }

      function hide(){
        el.classList.remove('show');
        el.style.display = 'none';
      }
      function show(){
        el.style.display = 'block';
        requestAnimationFrame(()=> el.classList.add('show'));
      }

      // Open in new tab with return path (optional)
      const base = 'https://mypybite.substack.com/subscribe';
      const next = encodeURIComponent(location.href);
      linkYes.href = `${base}?next=${next}`;

      // Wire controls
      btnX.addEventListener('click', () => {
        const s = getState();
        s.dismissed_until = now + days(14);   // 14-day cooldown on dismiss
        setState(s);
        hide();
      });
      btnNo.addEventListener('click', () => {
        const s = getState();
        s.dismissed_until = now + days(14);   // 14-day cooldown on "No thanks"
        setState(s);
        hide();
      });
      linkYes.addEventListener('click', () => {
        const s = getState();
        s.subscribed_until = now + days(60);  // longer cooldown if they clicked subscribe
        setState(s);
        hide();
      });

      // Esc closes
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') hide();
      });

      // Decide whether to show
      if (NOCTA) return;
      const s = getState();
      const gate = Math.max(s.dismissed_until || 0, s.subscribed_until || 0);
      if (gate && now < gate) return;

      // First paint: delay, then show (~7s)
      setTimeout(show, 7000);
    })();
  </script>
</body>
</html>
