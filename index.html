<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NewsRiver — Latest Headlines</title>

  <!-- Styles -->
  <link rel="stylesheet" href="assets/styles.css" />

  <!-- Social/SEO (optional) -->
  <meta name="description" content="Curated, newest-first news river with lightweight scoring and filters." />
</head>
<body>
  <header class="header">
    <h1 class="title">NewsRiver</h1>
    <p class="subtitle">Newest-first headlines (auto-built from RSS)</p>
  </header>

  <!-- Toolbar: filters on the left, “Last updated” chip will be injected on the right -->
  <section class="toolbar" role="region" aria-label="Controls">
    <div class="filters" id="filters">
      <!-- Category filters -->
      <button class="chip chip-active" data-filter="all" aria-pressed="true">All</button>
      <button class="chip" data-filter="Sports">Sports</button>
      <button class="chip" data-filter="General">General</button>

      <!-- Region filters -->
      <span class="divider" aria-hidden="true"></span>
      <button class="chip" data-region="Canada">Canada</button>
      <button class="chip" data-region="US">US</button>
      <button class="chip" data-region="World">World</button>
    </div>

    <!-- JS will append: <div id="last-updated" class="chip">Last updated: …</div> -->
  </section>

  <!-- Results -->
  <main id="grid" class="grid" aria-live="polite">
    <!-- Cards are injected here -->
  </main>

  <!-- Debug/links -->
  <footer class="footer">
    <a href="headlines.json" target="_blank" rel="noopener">View raw headlines.json</a>
    <span class="dot">•</span>
    <a href="https://github.com/MyPyBiTE/newsriver" target="_blank" rel="noopener">GitHub</a>
  </footer>

  <noscript>
    <p style="padding:1rem;max-width:800px;margin:1rem auto;background:#222;border-radius:12px;">
      JavaScript is required to load headlines. You can still view
      <a href="headlines.json">headlines.json</a>.
    </p>
  </noscript>

  <!-- Optional: point to your live JSON hosted on GitHub Pages -->
  <script>
    // If you serve index.html from somewhere else, keep this so the app reads the JSON from GitHub Pages.
    // You can remove or change this if your headlines.json is local.
    window.NEWSRIVER_JSON_URL = window.NEWSRIVER_JSON_URL || "https://mypybite.github.io/newsriver/headlines.json";
  </script>

  <!-- Data loader (fetch, strong de-dupe, per-source cap, stable order, filters, last-updated, auto-refresh) -->
  <script>
  (function(){
    "use strict";

    // ---------- DOM refs ----------
    const GRID = document.getElementById('grid');
    const FILTERS = document.getElementById('filters');
    const TOOLBAR = document.querySelector('.toolbar');

    // Create & insert the "Last updated" chip on the right
    const lastChip = document.createElement('div');
    lastChip.id = 'last-updated';
    lastChip.className = 'chip';
    lastChip.setAttribute('aria-live', 'polite');
    lastChip.textContent = 'Last updated: …';
    TOOLBAR.appendChild(lastChip);

    // Active filters (single category; single region)
    let activeCategory = 'all';
    let activeRegion = null;

    // ---------- Config ----------
    const JSON_URL = (window.NEWSRIVER_JSON_URL || 'headlines.json');
    const REFRESH_MS = 5 * 60 * 1000; // 5 minutes
    let lastStamp = null; // remember last generated_utc

    // Per-source caps (default = 1 per source)
    const CAP_PER_SOURCE_DEFAULT = 1;
    const CAP_OVERRIDES = {
      // Example bumps (edit as you like):
      "cbc.ca": 2,
      "globalnews.ca": 2,
      "reuters.com": 2,
      "financialpost.com": 2
    };

    // ---------- Utilities ----------
    const TZ = 'America/Toronto';

    const isValidDate = (v) => !!v && !Number.isNaN(Date.parse(v)));
    const fmtET = (iso) => {
      try {
        const d = new Date(iso);
        return new Intl.DateTimeFormat('en-CA', {
          year:'numeric', month:'short', day:'2-digit',
          hour:'2-digit', minute:'2-digit', hour12:false,
          timeZone: TZ
        }).format(d) + ' ET';
      } catch { return iso; }
    };
    const clearGrid = () => { GRID.innerHTML = ''; };

    function hourInTZ(){
      const p = new Intl.DateTimeFormat('en-CA',{ timeZone: TZ, hour: '2-digit', hour12: false })
        .formatToParts(new Date());
      const hh = Number(p.find(x=>x.type==='hour').value);
      return Number.isFinite(hh) ? hh : new Date().getHours();
    }

    // ---------- URL & source helpers ----------
    function hostOf(url) {
      try {
        const u = new URL(url, location.href);
        return (u.hostname || "").replace(/^www\./i,"").toLowerCase();
      } catch { return ""; }
    }
    function sourceKey(it) {
      // Prefer domain; fall back to source label lowercased
      return hostOf(it?.canonical_url || it?.url || "") || String(it?.source||"").toLowerCase();
    }

    // ---------- De-dupe helpers ----------
    function normalizeTitle(t) {
      return (t || "")
        .replace(/\s+[-–—]\s+[^|]+$/u, "")       // drop trailing " - Source"
        .toLowerCase()
        .replace(/[\u2010-\u2015]/g, "-")        // unify dashes
        .replace(/[^\p{L}\p{N}]+/gu, " ")        // remove punctuation
        .trim()
        .replace(/\s+/g, " ");
    }
    // Strong key: fuzzy title signature + domain (so “same headline” from same site collapses)
    function dedupeKey(it) {
      const t = normalizeTitle(it?.title || "");
      const h = hostOf(it?.canonical_url || it?.url || "");
      return `k:${t}|${h}`;
    }
    function isAggregator(it) {
      const src = `${it?.source || ""} ${it?.url || ""}`.toLowerCase();
      return /news\.google|google news|yahoo\.com\/news|apple\.news|flipboard|feedproxy/.test(src);
    }
    // Keep only the newest item per key; if tie, prefer non-aggregator.
    function dedupeItems(items) {
      const byKey = new Map();
      for (const it of items) {
        const key = dedupeKey(it);
        const prev = byKey.get(key);
        if (!prev) {
          byKey.set(key, it);
          continue;
        }
        const tNew = Date.parse(it.published_utc || it.published || 0) || 0;
        const tOld = Date.parse(prev.published_utc || prev.published || 0) || 0;

        if (tNew > tOld) {
          byKey.set(key, it);
        } else if (tNew === tOld) {
          if (isAggregator(prev) && !isAggregator(it)) byKey.set(key, it);
        }
      }
      return Array.from(byKey.values());
    }

    // ---------- Stable, monotonic “first seen” sequence ----------
    const SEQ_STORAGE_KEY = "nr_seq_v1";
    function loadSeqState() {
      try {
        const raw = localStorage.getItem(SEQ_STORAGE_KEY);
        if (!raw) return { counter: 0, map: {} };
        const parsed = JSON.parse(raw);
        return {
          counter: Number(parsed?.counter || 0),
          map: parsed?.map && typeof parsed.map === "object" ? parsed.map : {}
        };
      } catch { return { counter: 0, map: {} }; }
    }
    function saveSeqState(state) {
      try { localStorage.setItem(SEQ_STORAGE_KEY, JSON.stringify(state)); } catch {}
    }
    function getItemId(it) { return dedupeKey(it); }
    function assignStableSeq(items) {
      const state = loadSeqState();
      let touched = false;
      for (const it of items) {
        const id = getItemId(it);
        if (state.map[id] == null) {
          state.counter += 1;
          state.map[id] = state.counter;
          touched = true;
        }
        it.__seq = state.map[id];
      }
      if (touched) saveSeqState(state);
      return items;
    }

    // ---------- Per-source cap (variety guard) ----------
    function applySourceCap(sortedItems) {
      const counts = Object.create(null);
      const out = [];
      for (const it of sortedItems) {
        const key = sourceKey(it);
        const limit = CAP_OVERRIDES[key] ?? CAP_PER_SOURCE_DEFAULT;
        const n = counts[key] || 0;
        if (n < limit) {
          out.push(it);
          counts[key] = n + 1;
        }
      }
      return out;
    }

    // ---------- Render ----------
    function makeCard(item){
      const card = document.createElement('article');
      card.className = 'card';
      card.dataset.category = item.category || '';
      card.dataset.region = item.region || '';

      const link = document.createElement('a');
      link.className = 'card-link';
      link.href = item.url;
      link.target = '_blank';
      link.rel = 'noopener';
      link.setAttribute('aria-label', item.title || 'Open headline');

      const h2 = document.createElement('h2');
      h2.className = 'headline';
      h2.textContent = item.title || '(untitled)';

      link.appendChild(h2);

      const meta = document.createElement('div');
      meta.className = 'meta';

      const src = document.createElement('span');
      src.className = 'source';
      src.textContent = item.source || '';

      const cat = document.createElement('span');
      cat.className = 'tag';
      cat.textContent = item.category || '';

      const reg = document.createElement('span');
      reg.className = 'tag';
      reg.textContent = item.region || '';

      meta.appendChild(src);
      if (item.category){ meta.appendChild(document.createTextNode(' \u2022 ')); meta.appendChild(cat); }
      if (item.region){ meta.appendChild(document.createTextNode(' \u2022 ')); meta.appendChild(reg); }

      card.appendChild(link);
      card.appendChild(meta);
      return card;
    }

    function render(items){
      clearGrid();
      if (!items || items.length === 0){
        const p = document.createElement('p');
        p.className = 'empty';
        p.textContent = 'No headlines match your filters.';
        GRID.appendChild(p);
        return;
      }
      const frag = document.createDocumentFragment();
      items.forEach(it => frag.appendChild(makeCard(it)));
      GRID.appendChild(frag);
    }

    function applyFilters(all){
      const filtered = all.filter(it =>
        (activeCategory === 'all' || (it.category || '') === activeCategory) &&
        (!activeRegion || (it.region || '') === activeRegion)
      );
      render(filtered);
    }

    function setLastUpdated(isoMaybe){
      if (isValidDate(isoMaybe)) {
        lastChip.textContent = 'Last updated: ' + fmtET(isoMaybe);
      } else {
        lastChip.textContent = 'Last updated: just now';
      }
    }

    // ---------- Thematic + daypart scoring (adds “time credit” in minutes) ----------
    // The “5% stronger” nudges are implemented as small additive time credits.
    // Tweak here without touching the rendering pipeline.

    const MINUTE = 60 * 1000;
    const BUMP_5 = 12 * MINUTE;           // ~5% nudge unit
    const BUMP_8 = 18 * MINUTE;           // slightly stronger
    const BUMP_10 = 24 * MINUTE;          // stronger
    const WAR_BUMP = 60 * MINUTE;         // high-priority war/security
    const TIER1_BUMP = 6 * MINUTE;        // mild nudge for tier-1 sources
    const FINALS_BUMP = 15 * MINUTE;      // end-of-game closure nudge
    const ATHLETE_BUMP = 12 * MINUTE;     // named athlete nudge
    const KIRK_EXTRA = 6 * MINUTE;        // Alejandro Kirk extra (on top of athlete)
    const BOOST_CAP = 3 * 60 * MINUTE;    // avoid bulldozing

    const RE_TIER1 = /\b(associated press|^ap$|reuters|bbc|bloomberg|financial times|wall street journal|washington post|the guardian|new york times|nyt)\b/i;

    // Business/markets (morning)
    const RE_CRYPTO = /\b(crypto|bitcoin|btc|ethereum|eth|halving|stablecoin|defi|satoshi)\b/i;
    const RE_MEME = /\b(gamestop|gme|amc)\b/i;
    const RE_TECH = /\b(nvda|nvidia|msft|microsoft|aapl|apple|amzn|amazon|googl?|google|alphabet|meta|facebook|tsla|tesla|ai|chip(?:s|makers)?|semiconductor)\b/i;

    // War/security (always-on) — must match a region + an event word
    const RE_WAR_EVENT = /\b(war|attack|attacks|attacked|strike|air[-\s]?strike|missile|drone|invasion|mobilization|shell(?:ing)?|artillery|frontline|casualties?|dead|killed)\b/i;
    const RE_WAR_REGION = /\b(russia|ukraine|poland|serbia|croatia|bosnia|herzegovina|kosovo|montenegro|slovenia|macedonia|albania|hungary|slovakia|czech|austria|romania|bulgaria|balkan|central europe|canada|united states|u\.s\.|usa)\b/i;

    // Sports (afternoon/evening) — teams and athletes
    const RE_SPORTS_TEAMS = /\b(toronto (blue\s?jays|maple\s?leafs|raptors)|new york yankees|boston red sox|detroit tigers|los angeles dodgers)\b/i;
    const RE_SPORTS_ATHLETES = /\b(shohei ohtani|vladimir guerrero(?: jr\.?)?|george springer|bo bichette|max scherzer|alejandro kirk)\b/i;
    const RE_KIRK = /\balejandro kirk\b/i;
    // “Final”/closure words or scorelines like 3-1 / 10–2
    const RE_FINALS_CUE = /\b(final|wins?|defeats?|beats?|edges?|falls?|prevails?|clinches?|walk-off|walkoff)\b|(?:\b\d{1,2}\s?[–-]\s?\d{1,2}\b)/i;

    function computeBoostMs(it, hour){
      const title = String(it?.title || '');
      const source = String(it?.source || '');
      let boost = 0;

      // Always-on: war & security (region + event)
      if (RE_WAR_EVENT.test(title) && RE_WAR_REGION.test(title)) {
        boost += WAR_BUMP; // big shove any time of day
      }

      // Dayparts (Toronto time)
      // Morning 06:00–13:00 → business/markets
      if (hour >= 6 && hour < 13){
        if (RE_CRYPTO.test(title)) boost += BUMP_10 + BUMP_5; // crypto gets the biggest morning nudge
        if (RE_MEME.test(title))   boost += BUMP_8;           // meme stocks strong
        if (RE_TECH.test(title))   boost += BUMP_5;           // general tech tickers light+
      }

      // Afternoon/Evening 15:00–23:30 → sports dopamine
      if (hour >= 15 && hour <= 23){
        if (RE_SPORTS_TEAMS.test(title))   boost += BUMP_8;   // team match
        if (RE_SPORTS_ATHLETES.test(title)) boost += ATHLETE_BUMP; // athlete mention
        if (RE_KIRK.test(title))           boost += KIRK_EXTRA;    // extra extra for Kirk
        if (RE_FINALS_CUE.test(title))     boost += FINALS_BUMP;   // end-of-game closure
      }

      // Mild tier-1 nudge (doesn't override content intent)
      if (RE_TIER1.test(source)) boost += TIER1_BUMP;

      // Clamp
      if (boost > BOOST_CAP) boost = BOOST_CAP;
      return boost;
    }

    function scoringSort(items){
      const now = Date.now();
      const hr = hourInTZ();

      for (const it of items){
        const pubMs = Date.parse(it.published_utc || it.published || 0) || 0;
        const base = pubMs || (now - (it.__seq || 0)); // tiny fallback if no date
        const bonus = computeBoostMs(it, hr);
        // __seq used as ultra-small stabilizer inside ties
        it.__score = base + bonus + ((it.__seq || 0) % 997); // tiny tie shaper
      }

      // Highest score first (recency + boosts)
      items.sort((a,b) => (b.__score||0) - (a.__score||0));
      return items;
    }

    // ---------- Normalize incoming data (de-dupe + seq + SCORE + per-source cap) ----------
    function normalizeData(data){
      if (!data || !Array.isArray(data.items)) return { items: [] };

      // A) strong de-dupe (title sig + domain; prefer originals over aggregators)
      let items = dedupeItems(data.items.slice());

      // B) stable first-seen id (for gentle tie shaping)
      assignStableSeq(items);

      // C) score by recency + daypart/topic boosts
      scoringSort(items);

      // D) cap per source to keep variety (default 1 unless overridden)
      items = applySourceCap(items);

      return { ...data, items };
    }

    // ---------- Fetch helpers ----------
    async function loadJson() {
      const url = `${JSON_URL}?t=${Date.now()}`; // cache-buster
      const resp = await fetch(url, { cache: 'no-store' });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return await resp.json();
    }

    async function bootstrap() {
      try {
        const data = await loadJson();
        const normalized = normalizeData(data);

        // Save for re-filtering via the toolbar
        window.__NR_ALL_ITEMS__ = normalized.items;

        // Set “Last updated” using generated_utc (preferred) or newest item time
        const lastIso = data.generated_utc && isValidDate(data.generated_utc)
          ? data.generated_utc
          : (normalized.items.find(it => isValidDate(it.published_utc))?.published_utc || null);

        setLastUpdated(lastIso);
        lastStamp = data.generated_utc || null;

        // Initial render
        applyFilters(normalized.items);
      } catch (err) {
        console.error('Headlines load failed:', err);
        setLastUpdated(null);
        clearGrid();
        const p = document.createElement('p');
        p.className = 'error';
        p.textContent = 'Could not load headlines. Try opening headlines.json directly or refresh.';
        GRID.appendChild(p);
      }
    }

    function autoRefresh() {
      setInterval(async () => {
        try {
          const data = await loadJson();
          if (!data) return;

          const stamp = data.generated_utc || null;
          if (stamp && stamp !== lastStamp) {
            const normalized = normalizeData(data);
            window.__NR_ALL_ITEMS__ = normalized.items;
            setLastUpdated(stamp);
            lastStamp = stamp;
            applyFilters(normalized.items);

            lastChip.classList.add('pulse');
            setTimeout(() => lastChip.classList.remove('pulse'), 900);
          }
        } catch (e) {
          console.warn('Auto-refresh failed:', e.message);
        }
      }, REFRESH_MS);
    }

    // ---------- Filter click handling (single-select per group) ----------
    FILTERS.addEventListener('click', (e) => {
      const btn = e.target.closest('button.chip');
      if (!btn) return;

      // Category group
      if (btn.hasAttribute('data-filter')){
        FILTERS.querySelectorAll('[data-filter]').forEach(b => {
          b.classList.remove('chip-active');
          b.setAttribute('aria-pressed', 'false');
        });
        btn.classList.add('chip-active');
        btn.setAttribute('aria-pressed', 'true');
        activeCategory = btn.getAttribute('data-filter') || 'all';
        applyFilters(window.__NR_ALL_ITEMS__ || []);
      }

      // Region group (toggle single-select)
      if (btn.hasAttribute('data-region')){
        const region = btn.getAttribute('data-region') || null;
        if (activeRegion === region){
          activeRegion = null;
          btn.classList.remove('chip-active');
          btn.setAttribute('aria-pressed', 'false');
        } else {
          FILTERS.querySelectorAll('[data-region]').forEach(b => {
            b.classList.remove('chip-active');
            b.setAttribute('aria-pressed', 'false');
          });
          activeRegion = region;
          btn.classList.add('chip-active');
          btn.setAttribute('aria-pressed', 'true');
        }
        applyFilters(window.__NR_ALL_ITEMS__ || []);
      }
    });

    // ---------- Go ----------
    bootstrap();
    autoRefresh();
  })();
  </script>
</body>
</html>
